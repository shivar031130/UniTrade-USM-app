<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cart ‚Äî UniTrade</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === CORE STYLES === */
    :root[data-theme="dark"]{
        --bg:#0f172a; --card:#1e293b; --card-hover:#2d3b52; --muted:#94a3b8; --accent:#3b82f6; --accent-hover:#2563eb;
        --success:#10b981; --gradient-1:#6366f1; --gradient-2:#8b5cf6; --gradient-3:#ec4899;
        --text:#f1f5f9; --text-secondary:#cbd5e1; --border:rgba(148, 163, 184, 0.1);
        --shadow:rgba(0,0,0,.3); --input-bg:rgba(15, 23, 42, 0.5);
    }
    :root[data-theme="light"]{
        --bg:#f1f5f9; --card:#ffffff; --card-hover:#f8fafc; --muted:#64748b; --accent:#3b82f6; --accent-hover:#2563eb;
        --success:#10b981; --gradient-1:#6366f1; --gradient-2:#8b5cf6; --gradient-3:#ec4899;
        --text:#0f172a; --text-secondary:#475569; --border:rgba(15, 23, 42, 0.1);
        --shadow:rgba(0,0,0,.1); --input-bg:#f8fafc;
    }
    * { box-sizing: border-box; }
    
    body{
        margin:0; font-family:'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
        padding:32px 40px; transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1, h2, h3 { letter-spacing: -0.5px; }

    /* Buttons */
    .btn{
        background:linear-gradient(135deg, var(--accent), var(--accent-hover)); 
        color:white; border:none; padding: 12px 20px; border-radius:12px; cursor:pointer; 
        font-weight:600; font-size:14px; transition:all 0.3s ease;
        box-shadow:0 4px 12px rgba(59, 130, 246, 0.3); text-decoration: none; display: inline-block;
        text-align: center;
    }
    .btn:hover{transform:translateY(-2px); box-shadow:0 6px 20px rgba(59, 130, 246, 0.4);}
    .btn:disabled { background: var(--card-hover); color: var(--muted); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
    .btn.ghost { background: transparent; border: 1px solid var(--border); box-shadow: none; color: var(--text); width: auto; }
    .btn.ghost:hover { background: var(--card-hover); border-color: var(--accent); }

    /* Layout */
    .page-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--border);
    }
    .page-header h1 { font-size: 32px; letter-spacing: -1.5px; margin: 0; }
    .cart-layout { display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap: 32px; align-items: flex-start; }
    .cart-items-panel { display: flex; flex-direction: column; gap: 20px; }
    .cart-summary-panel { position: sticky; top: 32px; }

    /* Cart Items */
    .cart-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 8px; font-size: 13px; color: var(--muted);
        text-transform: uppercase; letter-spacing: 0.8px;
    }

    .cart-item {
        background: var(--card); padding: 20px; border-radius: 16px;
        border: 1px solid var(--border); box-shadow: 0 8px 16px -4px var(--shadow);
        display: flex; align-items: center; gap: 20px;
        transition: all 0.3s ease;
    }
    .cart-item:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -4px var(--shadow); }
    
    .item-image {
        width: 88px; height: 88px; border-radius: 12px;
        background: var(--input-bg); overflow: hidden; flex-shrink: 0;
    }
    .item-image img { width: 100%; height: 100%; object-fit: cover; }
    
    .item-details { flex: 1; min-width: 0; }
    .item-details h3 { margin: 0 0 4px; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-details h3 a { color: var(--text); text-decoration: none; transition: color 0.2s; }
    .item-details h3 a:hover { color: var(--accent); }
    .item-details .muted { font-size: 13px; color: var(--muted); }
    
    .item-price { font-weight: 700; font-size: 18px; width: 120px; text-align: right; flex-shrink: 0; color: var(--success); }
    
    /* Quantity */
    .item-quantity { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 99px; overflow: hidden; background: var(--input-bg); }
    .item-quantity button { background: transparent; border: none; color: var(--text); width: 32px; height: 32px; cursor: pointer; font-size: 18px; line-height: 32px; transition: all 0.2s; }
    .item-quantity button:hover { background: var(--accent); color: white; }
    .item-quantity input { width: 40px; height: 32px; text-align: center; border: none; background: transparent; color: var(--text); font-weight: 500; padding: 0; font-size: 14px; pointer-events: none; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { appearance: none; margin: 0; }
    
    .item-actions button { background: none; border: none; color: var(--muted); cursor: pointer; padding: 8px; transition: all 0.2s; }
    .item-actions button:hover { color: #ef4444; transform: scale(1.1); }
    
    /* Checkbox */
    .styled-checkbox { display: flex; align-items: center; cursor: pointer; user-select: none; }
    .styled-checkbox input { display: none; }
    .styled-checkbox .checkmark {
        width: 24px; height: 24px; background: var(--input-bg); border: 1px solid var(--border);
        border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .styled-checkbox:hover .checkmark { border-color: var(--accent); }
    .styled-checkbox input:checked ~ .checkmark { background: var(--accent); border-color: var(--accent); }
    .checkmark svg { width: 16px; height: 16px; stroke: white; stroke-width: 2.5; opacity: 0; transform: scale(0.8); transition: all 0.2s; }
    .styled-checkbox input:checked ~ .checkmark svg { opacity: 1; transform: scale(1); }

    /* Summary */
    .cart-summary {
        background: var(--card); padding: 24px; border-radius: 16px;
        border: 1px solid var(--border); box-shadow: 0 8px 16px -4px var(--shadow);
    }
    .cart-summary h2 { margin: 0 0 24px; font-size: 22px; }
    .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); }
    .summary-row.total { 
        font-weight: 700; font-size: 20px; color: var(--text);
        border-top: 1px solid var(--border); padding-top: 20px; margin-top: 20px; 
    }
    .summary-row.total span:last-child {
        background: linear-gradient(135deg, var(--gradient-1), var(--gradient-2));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-clip: text; text-fill-color: transparent; font-weight: 800;
    }
    .cart-summary .btn { width: 100%; margin-top: 24px; font-size: 16px; padding: 16px; }

    /* Empty Cart */
    .empty-cart {
        text-align: center; padding: 80px 40px; background: var(--card); border-radius: 20px;
        border: 1px solid var(--border);
    }
    .empty-cart .icon-wrap {
        width: 80px; height: 80px; margin: 0 auto 24px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.15), transparent 70%);
    }
    .empty-cart svg { width: 48px; height: 48px; color: var(--accent); }
    .empty-cart h2 { margin: 0 0 8px; font-size: 24px; }
    .empty-cart p { color: var(--muted); margin: 0 0 24px; max-width: 300px; margin-left: auto; margin-right: auto; }

    /* Toast Notification */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; border-radius: 12px; background: var(--success); color: white; font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: var(--danger); }

    /* Animations */
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3), 0 6px 20px rgba(59, 130, 246, 0.4); }
        50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5), 0 6px 20px rgba(59, 130, 246, 0.6); }
    }
    .btn-pulse-glow { animation: pulse-glow 2s infinite ease-in-out; }
    
    @keyframes fade-out-and-shrink {
        from { opacity: 1; max-height: 150px; transform: scaleY(1); margin-bottom: 20px; }
        to { opacity: 0; max-height: 0; transform: scaleY(0); margin-bottom: 0; padding-top: 0; padding-bottom: 0; }
    }
    .item-removing { animation: fade-out-and-shrink 0.5s ease-out forwards; overflow: hidden; }

    /* Responsive */
    @media(max-width: 900px) {
        body { padding: 24px; }
        .cart-layout { grid-template-columns: 1fr; }
        .cart-summary-panel { position: static; }
    }
    @media(max-width: 600px) {
        body { padding: 16px; }
        .page-header { flex-direction: column; gap: 16px; }
        .cart-item { flex-wrap: wrap; gap: 12px; }
        .item-details { width: 100%; order: 1; margin-left: 36px; }
        .item-quantity, .item-actions, .item-price { margin-top: 12px; }
        .item-price { width: auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
        <h1>Shopping Cart</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn ghost" onclick="toggleTheme()" id="themeIcon" style="padding:10px 14px;">üåô</button>
            <a href="index.html" class="btn ghost">‚Üê Continue Shopping</a>
        </div>
    </div>
    
    <div class="cart-layout">
        <div class="cart-items-panel">
            <div class="cart-header">
                <label class="styled-checkbox">
                    <input type="checkbox" id="selectAll" />
                    <span class="checkmark">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5"></path></svg>
                    </span>
                    <span style="margin-left:12px;">Select all</span>
                </label>
                <div id="itemCount">Loading...</div>
            </div>
            <div id="cartItemsContainer">
                </div>
        </div>

        <div class="cart-summary-panel">
            <div class="cart-summary">
                <h2>Order Summary</h2>
                <div class="summary-row">
                    <span>Subtotal (<span id="summaryCount">0</span> items)</span>
                    <span id="summarySubtotal">RM 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span style="color: var(--success);">FREE (Campus)</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="summaryTotal">RM 0.00</span>
                </div>
                <button id="checkoutBtn" class="btn" disabled>Proceed to Checkout</button>
            </div>
        </div>
    </div>
  </div>

  <div class="toast" id="toast">Notification</div>

  <script>
    // =================================================================
    // 1. SUPABASE CONFIG
    // =================================================================
    const SUPABASE_URL = 'https://dkpnhswjjmjligemxoet.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcG5oc3dqam1qbGlnZW14b2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNTg4MjksImV4cCI6MjA4MTczNDgyOX0.aGk9fC0-u_ClnxfOVh_BH4_Xj-cF7i0_XVydYV_T-RM';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =================================================================
    // 2. THEME LOGIC
    // =================================================================
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeIcon').innerText = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    const t = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', t);
    document.getElementById('themeIcon').innerText = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';

    // =================================================================
    // 3. MAIN CART LOGIC
    // =================================================================
    async function loadCart() {
      try {
        // 1. Check Auth
        const { data: { session } } = await _supabase.auth.getSession();
        
        if (!session) {
          // Empty State - Not Logged In
          document.querySelector('.cart-layout').innerHTML = `
            <div class="empty-cart" style="grid-column: 1 / -1;">
              <div class="icon-wrap">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
              </div>
              <h2>Please login to view your cart</h2>
              <p>Sign in to access your saved items and proceed to checkout.</p>
              <a href="index.html" class="btn">Login</a>
            </div>
          `;
          return;
        }

        // 2. Fetch Cart Items (Include stock_quantity now)
        const { data: cart, error } = await _supabase
            .from('cart')
            .select(`
                id,
                quantity,
                listings:listing_id (
                    id, title, price, image_url, condition, stock_quantity,
                    profiles:seller_id (full_name)
                )
            `)
            .eq('user_id', session.user.id);

        if(error) throw error;

        renderCartItems(cart || []);
        updateSummary();

      } catch (err) {
        console.error('Failed to load cart:', err);
      }
    }

    // --- RENDER CART ITEMS ---
    function renderCartItems(items) {
      const container = document.getElementById('cartItemsContainer');
      const itemCountEl = document.getElementById('itemCount');

      if (!items || items.length === 0) {
        document.querySelector('.cart-layout').innerHTML = `
          <div class="empty-cart" style="grid-column: 1 / -1;">
            <div class="icon-wrap">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            </div>
            <h2>Your cart is empty</h2>
            <p>Looks like you haven't added anything to your cart yet.</p>
            <a href="index.html" class="btn">Start Shopping</a>
          </div>
        `;
        return;
      }

      itemCountEl.textContent = `${items.length} Item${items.length > 1 ? 's' : ''}`;
      
      container.innerHTML = items.map(item => {
        const product = item.listings;
        const cartId = item.id;
        const listingId = product.id;
        const qty = item.quantity;
        const maxStock = product.stock_quantity;
        
        // Handle Image URL
        const image = product.image_url.startsWith('http') ? product.image_url : `assets/products/${product.image_url}`;
        
        return `
            <div class="cart-item" id="item-${cartId}">
                <label class="styled-checkbox">
                    <input type="checkbox" class="cart-checkbox" value="${cartId}" data-price="${product.price}" data-qty="${qty}" onchange="updateSummary()" />
                    <span class="checkmark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5"></path></svg></span>
                </label>
                
                <div class="item-image">
                    <img src="${image}" alt="${product.title}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                </div>
                
                <div class="item-details">
                    <h3><a href="products.html?id=${listingId}">${product.title}</a></h3>
                    <div class="muted">Seller: ${product.profiles?.full_name || 'User'} &bull; Stock: ${maxStock}</div>
                </div>
                
                <div class="item-quantity">
                    <button onclick="updateQty('${cartId}', -1, ${maxStock})">-</button>
                    <input id="qty_${cartId}" type="number" value="${qty}" readonly />
                    <button onclick="updateQty('${cartId}', 1, ${maxStock})">+</button>
                </div>
                
                <div class="item-price">RM ${product.price.toFixed(2)}</div>
                
                <div class="item-actions">
                    <button onclick="removeItem('${cartId}')" title="Remove item">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
        `;
      }).join('');

      // Select All Logic
      document.getElementById('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.cart-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateSummary();
      });
    }

    // --- ACTIONS ---

    // 1. Update Quantity with Stock Limit Check
    async function updateQty(cartId, delta, maxStock) {
        const input = document.getElementById(`qty_${cartId}`);
        let newQty = parseInt(input.value) + delta;

        // Validation: Min 1
        if(newQty < 1) return;

        // Validation: Max Stock
        if(newQty > maxStock) {
            showToast(`Only ${maxStock} items available in stock.`, 'error');
            return;
        }

        // UI Optimistic Update
        input.value = newQty;
        
        // Update checkbox data attribute
        const checkbox = document.querySelector(`.cart-checkbox[value="${cartId}"]`);
        if (checkbox) {
            checkbox.dataset.qty = newQty;
        }
        
        updateSummary();

        // Backend Update
        const { error } = await _supabase.from('cart').update({ quantity: newQty }).eq('id', cartId);
        if(error) console.error("Update failed", error);
    }

    // 2. Remove Item
    async function removeItem(cartId) {
        if (!confirm("Remove this item?")) return;

        const itemEl = document.getElementById(`item-${cartId}`);
        itemEl.classList.add('item-removing'); // Play animation

        const { error } = await _supabase.from('cart').delete().eq('id', cartId);
        
        if(!error) {
            setTimeout(() => {
                loadCart(); 
            }, 500);
        } else {
            alert(error.message);
            itemEl.classList.remove('item-removing');
        }
    }

    // 3. Update Totals
    function updateSummary() {
      const checkboxes = document.querySelectorAll('.cart-checkbox:checked');
      let total = 0;
      let count = 0;

      checkboxes.forEach(cb => {
        const price = parseFloat(cb.dataset.price);
        const qty = parseInt(cb.dataset.qty); 
        total += price * qty;
        count += qty;
      });

      document.getElementById('summaryCount').textContent = count;
      document.getElementById('summarySubtotal').textContent = `RM ${total.toFixed(2)}`;
      document.getElementById('summaryTotal').textContent = `RM ${total.toFixed(2)}`;
      
      const btn = document.getElementById('checkoutBtn');
      btn.disabled = count === 0;
      if(count > 0) btn.classList.add('btn-pulse-glow');
      else btn.classList.remove('btn-pulse-glow');
    }

    // 4. Checkout Handler
    document.getElementById('checkoutBtn').onclick = () => {
        const selectedIds = Array.from(document.querySelectorAll('.cart-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return alert("Please select item to checkout.");
        sessionStorage.setItem('checkoutItems', JSON.stringify(selectedIds));
        window.location.href = 'payment.html';
    };

    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = `toast show ${type}`;
        setTimeout(() => t.className = 'toast', 3000);
    }
// === AUTO-LOGOUT SYSTEM (20 MINS) ===
    (function() {
        // 1. Check if user is logged in
        const session = localStorage.getItem('sb-dkpnhswjjmjligemxoet-auth-token'); // Checks for Supabase session
        if (!session) return; // If no session, no need to run timer

        // 2. Check "Remember Me" preference
        const isRemembered = localStorage.getItem('uniTrade_remember') === 'true';

        if (isRemembered) {
            console.log("üîí Remember Me active: Auto-logout disabled.");
            return;
        }

        console.log("‚è≥ Public Session: Auto-logout enabled (20 mins).");

        // 3. Setup Timer
        const TIMEOUT_LIMIT = 20 * 60 * 1000; // 20 Minutes
        let idleTimer;

        function resetTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(logoutUser, TIMEOUT_LIMIT);
        }

        async function logoutUser() {
            // Use the global _supabase client if available, otherwise assume session expired
            if (window._supabase) {
                await window._supabase.auth.signOut();
            }
            alert("For your security, you have been logged out due to 20 minutes of inactivity.");
            window.location.href = 'index.html';
        }

        // 4. Listen for any movement
        window.onload = resetTimer;
        document.onmousemove = resetTimer;
        document.onkeypress = resetTimer;
        document.onclick = resetTimer;
        document.onscroll = resetTimer;
    })();
    // Start
    loadCart();
  </script>
</body>
</html>