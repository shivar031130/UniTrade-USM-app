<!doctype html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password ‚Äî UniTrade</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root[data-theme="dark"]{ --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --border:rgba(148,163,184,0.1); --accent:#3b82f6; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: var(--card); padding: 40px; border-radius: 16px; border: 1px solid var(--border); width: 100%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        .msg { margin-top: 15px; text-align: center; font-size: 14px; color: #ef4444; }
    </style>
</head>
<body>

<div class="card">
    <h2>Set New Password</h2>
    <p style="color:#94a3b8; text-align:center; font-size:14px; margin-bottom:20px;">Enter your new password below.</p>
    
    <form id="resetForm">
        <input type="password" id="newPass" placeholder="New Password" required minlength="6">
        <input type="password" id="confirmPass" placeholder="Confirm Password" required minlength="6">
        <button type="submit">Update Password</button>
    </form>
    <div id="message" class="msg"></div>
</div>

<script>
    const SUPABASE_URL = 'https://dkpnhswjjmjligemxoet.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrcG5oc3dqam1qbGlnZW14b2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNTg4MjksImV4cCI6MjA4MTczNDgyOX0.aGk9fC0-u_ClnxfOVh_BH4_Xj-cF7i0_XVydYV_T-RM';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 1. Check if we have a valid session (User clicked the email link)
    async function checkSession() {
        // Supabase automatically handles the hash fragment tokens from the URL
        const { data: { session }, error } = await _supabase.auth.getSession();
        
        if (!session) {
            document.body.innerHTML = `
                <div class="card" style="text-align:center;">
                    <h2 style="color:#ef4444">Invalid Link</h2>
                    <p>This password reset link is invalid or has expired.</p>
                    <a href="index.html" style="color:var(--accent)">Go Home</a>
                </div>`;
        }
    }

    // 2. Handle Password Update
    document.getElementById('resetForm').onsubmit = async (e) => {
        e.preventDefault();
        const p1 = document.getElementById('newPass').value;
        const p2 = document.getElementById('confirmPass').value;
        const msg = document.getElementById('message');
        const btn = e.target.querySelector('button');

        if (p1 !== p2) {
            msg.innerText = "Passwords do not match!";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Updating...";
        msg.innerText = "";

        const { error } = await _supabase.auth.updateUser({ password: p1 });

        if (error) {
            msg.innerText = error.message;
            btn.disabled = false;
            btn.innerText = "Update Password";
        } else {
            document.querySelector('.card').innerHTML = `
                <h2 style="color:#10b981">Success! üéâ</h2>
                <p style="text-align:center; color:#94a3b8;">Your password has been updated.</p>
                <button onclick="window.location.href='index.html'">Login Now</button>
            `;
        }
    };
// === AUTO-LOGOUT SYSTEM (20 MINS) ===
    (function() {
        // 1. Check if user is logged in
        const session = localStorage.getItem('sb-dkpnhswjjmjligemxoet-auth-token'); // Checks for Supabase session
        if (!session) return; // If no session, no need to run timer

        // 2. Check "Remember Me" preference
        const isRemembered = localStorage.getItem('uniTrade_remember') === 'true';

        if (isRemembered) {
            console.log("üîí Remember Me active: Auto-logout disabled.");
            return;
        }

        console.log("‚è≥ Public Session: Auto-logout enabled (20 mins).");

        // 3. Setup Timer
        const TIMEOUT_LIMIT = 20 * 60 * 1000; // 20 Minutes
        let idleTimer;

        function resetTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(logoutUser, TIMEOUT_LIMIT);
        }

        async function logoutUser() {
            // Use the global _supabase client if available, otherwise assume session expired
            if (window._supabase) {
                await window._supabase.auth.signOut();
            }
            alert("For your security, you have been logged out due to 20 minutes of inactivity.");
            window.location.href = 'index.html';
        }

        // 4. Listen for any movement
        window.onload = resetTimer;
        document.onmousemove = resetTimer;
        document.onkeypress = resetTimer;
        document.onclick = resetTimer;
        document.onscroll = resetTimer;
    })();
    checkSession();
</script>

</body>
</html>